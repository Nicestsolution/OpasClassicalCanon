<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<title>Opa's klassieke canon</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* CSS styling voor leesbaarheid, responsiviteit en visuele structuur */
  #menu {
    margin-bottom: 1rem;
    display: flex;
    gap: 1rem;
  }
  #menu button, #playlistSelector, #viewSelector {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    background-color: #003366;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #menu button:hover, #playlistSelector:hover, #viewSelector:hover {
    background-color: #005599;
  }
  #playlistSelector option, #viewSelector option {
    color: black;
  }
  @media (max-width: 600px) {
    #menu {
      flex-direction: column;
    }
    #menu button, #playlistSelector, #viewSelector {
      font-size: 1.2rem;
    }
  }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    margin: 1rem;
    line-height: 1.6;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  h1, h2, h3 {
    margin-top: 1rem;
  }
  .song-block {
    margin-bottom: 1rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 1rem;
  }
  .composer-block {
    margin-bottom: 1rem;
    border-bottom: 2px solid #003366;
    padding-bottom: 1rem;
  }
  
  .collapsed {
    cursor: pointer;
    font-weight: bold;
    color: #003366;
    padding: 0.5rem;
    background-color: #f0f0f0;
    border-radius: 4px;
  }
  .collapsed:hover {
    background-color: #e0e0e0;
  }
  .expanded {
    margin-top: 0.5rem;
  }
  button {
    margin-top: 0.1rem;
    padding: 0.5rem 1rem;
	background-color: #e0e0e0;
	border-radius: 1rem;
    font-size: 1rem;
	color: #003366;
    cursor: pointer;
  }
  table.lyrics {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  table.lyrics th, table.lyrics td {
    border: 1px solid #ccc;
    padding: 0.2rem;
    vertical-align: top;
  }
  table.lyrics th {
    background-color: #f0f0f0;
    text-align: left;
  }
  @media (max-width: 600px) {
    body {
      font-size: 1.3rem;
    }
    h1, h2, h3 {
      font-size: 1.4rem;
    }
    p, .collapsed {
      font-size: 1.2rem;
    }
    .collapsed {
      padding: 0.75rem;
    }
  }
  svg {
    border: 1px solid #ccc;
  }
	.composer-name {
	  font-size: 1.2em;
	  color: #003366;
	  cursor: pointer;
	  display: flex;
	  flex-wrap: wrap;
	  align-items: baseline;
	  gap: 0.5em;
	}

	.composer-lifespan {
	  font-size: 0.9em;
	  font-weight: normal;
	  color: #555;
	}

</style>
</head>
<body>
<h1>Opa's klassieke canon</h1>
<nav id="menu">
  <select id="playlistSelector" onclick="updatePlaylist()" onchange="updatePlaylist()">
    <option value="canon">üéµ Speellijst Canon</option>
    <option value="kerstmis">üéÑ Speellijst Kerstmis</option>
    <option value="wiegelied">üõèÔ∏è Speellijst Wiegelied</option>
  </select>
  <select id="viewSelector" onchange="updateView()" onclick="updateView()">
    <option value="composers">üéº Componisten Lijst</option>
    <option value="timeline">üìÖ Componisten Tijdlijn</option>
  </select>
</nav>
<div id="playlist"></div>
<div id="content"></div>
<script>
const playlist = document.getElementById("playlist");
const content = document.getElementById("content");
let composers = [];
let songs = [];// Cross-browser veilige datum-parser.
// Safari kan problemen hebben met het rechtstreeks parsen van "YYYY-MM-DD".
// We maken daarom zelf een Date-object op basis van jaar/maand/dag wanneer mogelijk.
function parseDateSafe(text) {
  if (!text) return new Date(2000, 0, 1);
  const s = text.trim();
  // YYYY-MM-DD
  const iso = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if (iso) return new Date(parseInt(iso[1], 10), parseInt(iso[2], 10) - 1, parseInt(iso[3], 10));
  // YYYY/MM/DD
	const sl = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
  if (sl) return new Date(parseInt(sl[1], 10), parseInt(sl[2], 10) - 1, parseInt(sl[3], 10));
  // Normaliseer spaties/newlines (bijv. "2024\n 11\n 01") naar YYYY/MM/DD als mogelijk
  const nums = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
  if (nums) return new Date(parseInt(nums[1], 10), parseInt(nums[2], 10) - 1, parseInt(nums[3], 10));
  return new Date(s);
}

function showSection(section) {
  if (section === "playlist") {
    playlist.style.display = "block";
    content.style.display = "none";
  } else if (section === "content") {
    playlist.style.display = "none";
    content.style.display = "block";
  }
}

function updatePlaylist() {
  const selectedPlaylist = document.getElementById('playlistSelector').value;
  renderPlaylist(selectedPlaylist);
  showSection('playlist');
}

function formatLifeSpan(composer) {
  const birth = composer.birth || "";
  const placeOfBirth = composer.placeofbirth || "";
  const death = composer.death || "";
  const placeOfDeath = composer.placeofdeath || "";
  if (birth || death || placeOfBirth || placeOfDeath) {
    if (!death) {
      return `${placeOfBirth}: ${birth} ‚Äì heden`;
    }
    return `${placeOfBirth}: ${birth} ‚Äì ${placeOfDeath}: ${death}`;
  }
  return "";
}

function createSongDetailBlock(song) {
  const block = document.createElement("div");
  block.className = "song-detail-block";

  block.innerHTML = `
    <h3>${song.title}</h3>
    ${song.artist ? `<p><strong>Artiest:</strong> ${song.artist}</p>` : ""}
    ${song.appenddate ? `<p style="margin-top:0.2rem;"><em>Toegevoegd: ${new Date(song.appenddate).toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })}</em></p>` : ""}
    <p>${song.narrative || ""}</p>
    ${song.original && song.translation ? `
      <table class="lyrics">
        <tr><th>Origineel</th><th>Vertaling</th></tr>
        ${song.original.split("<br>").map((line, i) => `
          <tr>
            <td>${line}</td>
            <td>${song.translation.split("<br>")[i] || ""}</td>
          </tr>
        `).join("")}
      </table>
    ` : ""}
    ${song.spotify ? `<p><a href="${song.spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
  `;

  return block;
}

function renderPlaylist(selectedPlaylist) {
	playlist.innerHTML = '';
	content.innerHTML = '';
	const normalizedPlaylist = selectedPlaylist.trim().toLowerCase();
  
	const playlistLinks = {
	  canon: "https://open.spotify.com/playlist/4DqqTg8GBv4Ea8CzmoKraI?si=8b23b688f68341dc",
	  kerstmis: "https://open.spotify.com/playlist/6gDAHEQObs7pH0XR3h5J13?si=5b2ba7357143431c",
	  wiegelied: "https://open.spotify.com/playlist/2duZlB2x7ybq1OH9PwcXZX?si=d4d67d90f7dd4fe7"
	};
	
	const playlistNames = {
	  canon: "Opa's Klassieke Canon ",
	  kerstmis: "Opa's Kerstmuziek ",
	  wiegelied: "Opa's Wiegeliedjes "
	};

	const spotifyURL = playlistLinks[normalizedPlaylist];
	const playlistName = playlistNames[normalizedPlaylist];
	if (spotifyURL) {
	  const spotifyLink = document.createElement("div");
	  spotifyLink.innerHTML = `
		<a href="${spotifyURL}" target="_blank" style="text-decoration: none; font-weight: bold; display: inline-block; margin-bottom: 10px;">
		${playlistName} üéß Luister deze playlist op Spotify
		</a>
	  `;
	  playlist.appendChild(spotifyLink);
	}

  const filteredSongs = songs.filter(song =>     song.playlist?.trim().toLowerCase() === normalizedPlaylist);  
  filteredSongs.sort((a, b) => b.appenddate - a.appenddate);
  filteredSongs.forEach((song, index) => {
    const composer = composers.find(c => c.id === song.composerID);
    const composerName = composer ? `${composer.name}, ${composer.familyname}` : "Anoniem";
    const birth = composer ? composer.birth : "";
    const death = composer ? composer.death : "";
    const lifeSpan = composer ? formatLifeSpan(composer) : "";

    const block = document.createElement("div");
    block.className = "song-block";

    const collapsed = document.createElement("div");
    collapsed.className = "collapsed";
    collapsed.innerHTML = `<strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong>: ${song.title}`;

    const expanded = document.createElement("div");
    expanded.className = "expanded";
    expanded.style.display = index < 2 ? "block" : "none";
    collapsed.style.display = index < 2 ? "none" : "block";

    expanded.innerHTML = `
      <p style="font-size: 0.9rem; margin-bottom: 0.2rem;">
        <strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong> (${lifeSpan})
      </p>
      <h3>${song.title}</h3>
      ${song.artist ? `<p><strong>Artiest:</strong> ${song.artist}</p>` : ""}
      ${song.appenddate ? `<p style="margin-top:0.2rem;"><em>Toegevoegd: ${song.appenddate.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })}</em></p>` : ""}
      <p>${song.narrative}</p>
      ${song.original && song.translation ? `
        <table class="lyrics">
          <tr><th>Origineel</th><th>Vertaling</th></tr>
          ${song.original.split("<br>").map((line, i) => `
            <tr>
              <td>${line}</td>
              <td>${song.translation.split("<br>")[i] || ""}</td>
            </tr>
          `).join("")}
        </table>
      ` : ""}
      ${song.spotify ? `<p><a href="${song.spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
    `;

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Sluit";
    closeBtn.onclick = () => {
      expanded.style.display = "none";
      collapsed.style.display = "block";
    };
    expanded.appendChild(closeBtn);

    // Klikbare componistnaam in expanded // comment out in collapsed
    //collapsed.querySelector("a").addEventListener("click", e => {
    //  e.preventDefault();
    //  showComposerDetails(composer.id, "playlist");
    // });
    expanded.querySelector("a").addEventListener("click", e => {
      e.preventDefault();
      showComposerDetails(composer.id, "playlist");
    });

    collapsed.onclick = () => {
      expanded.style.display = "block";
      collapsed.style.display = "none";
    };

    block.appendChild(collapsed);
    block.appendChild(expanded);
    playlist.appendChild(block);
  });
} 

function renderComposers() {
	playlist.innerHTML = '';
	content.innerHTML = '';
	// alfabetisch
	composers.sort((a, b) => a.familyname.localeCompare(b.familyname));

	composers.forEach(composer => {
		const block = document.createElement("div");
		block.className = "composer-block";

		const lifeSpan = composer ? formatLifeSpan(composer) : "";
		const nameLine = `<strong>${composer.familyname}</strong>, ${composer.name}`;
		const styleLine = `<em>${composer.style}</em> (${lifeSpan})`;
		const birth = composer.birth || "?";
		const death = composer.death || "heden";
		//const narrative = composer.description || "";

		// Collapsed view
		const collapsed = document.createElement("div");
		collapsed.className = "composer-collapsed";
		collapsed.innerHTML = `
			<h2 class="composer-name">
				${composer.familyname}, ${composer.name}
				<span class="composer-lifespan">(${lifeSpan})</span>
			</h2>
		`;
	
		collapsed.style.cursor = "pointer";
		collapsed.querySelector('.composer-name').addEventListener('click', () => {
			collapsed.style.display = "none";
			expanded.style.display = "block";
		});

		// Expanded view
		const expanded = document.createElement("div");
		expanded.className = "composer-expanded";
		expanded.style.display = "none";
	
		// Expanded view Titel
		const title = document.createElement("h2");
		title.className = "composer-name";
		title.style.cursor = "pointer";
		title.style.color = "#003366";
		title.textContent = `${composer.familyname}, ${composer.name}`;
		expanded.appendChild(title);

		// Expanded view Stijl + levensspanne
		const stylePara = document.createElement("p");
		stylePara.innerHTML = `<em>${composer.style}</em> (${lifeSpan})`;
		expanded.appendChild(stylePara);

		// Expanded view Beschrijving
		const descPara = document.createElement("p");
		descPara.innerHTML = composer.description;
		expanded.appendChild(descPara);
	
		// Expanded view Songs
		const composerSongs = songs.filter(song => song.composerID === composer.id);
		composerSongs.forEach(song => {
			const songDiv = document.createElement("div");
			songDiv.className = "song-block";
			const collapsedSong = document.createElement("div");
			collapsedSong.className = "collapsed";
			collapsedSong.innerHTML = `<a href="#" text-decoration:none"></a>${song.title}`;

			const expandedSong = document.createElement("div");
			expandedSong.className = "expanded";
			expandedSong.style.display = "none";
			collapsedSong.style.display = "block";
			expandedSong.appendChild(createSongDetailBlock(song));
			
			// Toggle
			collapsedSong.onclick = () => {
				expandedSong.style.display = "block";
				collapsedSong.style.display = "none";
			};		
		
			// Sluit song knop
			const closeBtnSong = document.createElement("button");
			closeBtnSong.textContent = "Sluit muzieknummer";
			closeBtnSong.onclick = () => {
				expandedSong.style.display = "none";
				collapsedSong.style.display = "block";
			};
			expandedSong.appendChild(closeBtnSong);
				
			songDiv.appendChild(collapsedSong);
			songDiv.appendChild(expandedSong);
			expanded.appendChild(songDiv);
		});	

		// Sluit-knop
		const closeBtn = document.createElement("button");
		closeBtn.textContent = "Sluit Componist";
		closeBtn.onclick = () => {
			expanded.style.display = "none";
			collapsed.style.display = "block";
		};
		expanded.appendChild(closeBtn);

		// Toggle
		collapsed.onclick = () => {
			collapsed.style.display = "none";
			expanded.style.display = "block";
		};

		block.appendChild(collapsed);
		block.appendChild(expanded);
		content.appendChild(block);
	});
  
}

function renderComposerTimeline() {
	playlist.innerHTML = '';
	content.innerHTML = '';
	const svgNS = "http://www.w3.org/2000/svg";
	const svg = document.createElementNS(svgNS, "svg"); 
	const containerWidth = content.clientWidth || 800; // fallback
	const scaleWidth = 0.8 * containerWidth;
	const nameWidth = 0.2 * containerWidth;
	svg.setAttribute("width", containerWidth);
	const svgHeight = composers.length * 30 + 50;
	svg.setAttribute("height", svgHeight);
	
	svg.style.border = "1px solid #ccc";

	const startYear = 1000;
	const scaleExp = 3;
	const endYear = new Date().getFullYear();
	const totalYears = Math.pow(endYear/startYear, scaleExp) - 1;
  // const svgWidth = 1000; // px
	const yearToX = year => ((Math.pow(year/startYear,scaleExp) - 1) / totalYears) * scaleWidth + nameWidth;
	 
	const centuryMarks = [];

	for (let y = startYear; y <= endYear; y += 100) {
		centuryMarks.push(y);
	} 
	
	centuryMarks.forEach(year => {
		const x = yearToX(year);

		// Verticale lijn
		const line = document.createElementNS(svgNS, "line");
		line.setAttribute("x1", x);
		line.setAttribute("y1", 0);
		line.setAttribute("x2", x);
		line.setAttribute("y2", svgHeight); // of max y van je balken
		line.setAttribute("stroke", "#ccc");
		line.setAttribute("stroke-width", "1");
		svg.appendChild(line);

		// Label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", x - 5);
		label.setAttribute("y", 30); // bovenaan
		label.setAttribute("transform", `rotate(-45 ${x - 5},10)`); // 45¬∞ linksom
		label.setAttribute("font-size", "10");
		label.setAttribute("fill", "#333");
		label.textContent = year;
		svg.appendChild(label);
	}); 
  
	// chronologisch
	composers.sort((a, b) => a.birth - b.birth);

	// Levenslijn
	composers.forEach((composer, index) => {
	
		const style = composer.style.toLowerCase();
		const colorMap = {
			middeleeuws: "8C8F7C",
			renaissance: "15A65B",
			barok: "#8B0000",
			klassiek: "#1E90FF",
			romantiek: "#228B22",
			modern: "#FF8C00"
		};
		const fillColor = colorMap[style] || "#555";
		const death = composer.death || endYear;
		
		const y = index * 30 + 40;
		const line = document.createElementNS(svgNS, "rect");
		line.setAttribute("x", yearToX(composer.birth));
		line.setAttribute("y", y);
		line.setAttribute("width", yearToX(death) - yearToX(composer.birth));
		line.setAttribute("height", 10);
		line.setAttribute("fill", fillColor);
		line.style.cursor = "pointer";
		line.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		svg.appendChild(line);

		// Naam label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", 5);
		label.setAttribute("y", y + 8);
		label.setAttribute("fill", "#000");
		label.setAttribute("font-size", "12");
		label.textContent = composer.familyname;
		label.style.cursor = "pointer";
		label.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		svg.appendChild(label); 
  });

  content.appendChild(svg);
}

function updateView() {
  const view = document.getElementById('viewSelector').value;
  if (view === 'timeline') {
    showSection('content');
    renderComposerTimeline();
  } else {
    showSection('content');
    renderComposers();
  }
}

// Toon details van een enkele componist
function showComposerDetails(id, fromView) {
  showSection('content');
  content.innerHTML = '';
  const composer = composers.find(c => c.id === id);
  if (!composer) {
    content.textContent = 'Componist niet gevonden.';
    return;
  }
  const detailDiv = document.createElement('div');
  detailDiv.className = 'composer-detail';
  const lifeSpan = formatLifeSpan(composer);
  detailDiv.innerHTML = `
    <h2>${composer.name}, ${composer.familyname}</h2>
    <p><em>${composer.style}</em> (${lifeSpan})</p>
    <p>${composer.description}</p>
  `;

  const composerSongs = songs.filter(song => song.composerID === composer.id);
  composerSongs.forEach(song => {
    const songDiv = document.createElement('div');
    songDiv.className = 'song';
    /*
	songDiv.innerHTML = `
      <h3>${song.title}</h3>
      <p><em>${song.artist}</em></p>
    `;
	*/
	songDiv.innerHTML = `
      <h3>${song.title}</h3>
	`;
    detailDiv.appendChild(songDiv);
  });

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Sluit';
  closeBtn.style.marginTop = '1rem';
  closeBtn.style.padding = '0.5rem 1rem';
  closeBtn.style.fontSize = '1rem';
  closeBtn.style.backgroundColor = '#003366';
  closeBtn.style.color = 'white';
  closeBtn.style.border = 'none';
  closeBtn.style.borderRadius = '4px';
  closeBtn.style.cursor = 'pointer';
  closeBtn.addEventListener('click', () => {
    if (fromView === 'timeline') {
      updateView();
    } else if (fromView === 'composers') {
      updateView();
    } else {
      updatePlaylist();
      showSection('playlist');
    }
  });

  content.appendChild(detailDiv);
  content.appendChild(closeBtn);
}

function getTextContent(parent, selector) {
  const el = parent.querySelector(selector);
  return el ? el.textContent : "";
}

// Initialisatie: laad XML, parseer data, toon standaard playlist
fetch('canon.xml')
  .then(response => response.text())
  .then(xmlText => {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
    composers = Array.from(xmlDoc.querySelectorAll('composer')).map(c => ({
		id: 		getTextContent(c, "ID"),
		name: 		getTextContent(c, "name"),
		familyname: getTextContent(c, "familyname"),
		style: 		getTextContent(c, "style"),
		birth: 		getTextContent(c, "yearofbirth"), 
		placeofbirth: getTextContent(c, "placeofbirth"),
		death: 		getTextContent(c, "yearofdeath"), 
		placeofdeath: getTextContent(c, "placeofdeath"),
		description: getTextContent(c, "narrative"),
		// color: c.querySelector('color') ? c.querySelector('color').textContent : '#888'
    }));
    songs = Array.from(xmlDoc.querySelectorAll('song')).map(s => ({
      title: 		getTextContent(s, "title"),
      artist: 		getTextContent(s, "artist"),
      narrative: 	getTextContent(s, "narrative"),
      original: 	getTextContent(s, "original"),
      translation: 	getTextContent(s, "translation"),
      spotify: 		getTextContent(s, "spotify"),
      playlist: 	getTextContent(s, "playlist"),
      appenddate: parseDateSafe(getTextContent(s,"appenddate")), 
      composerID: 	getTextContent(s, "reference"),
	 	  
    }));
    updatePlaylist();
  });
 </script> 
 </body> 
 </html>