<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Opa's klassieke canon</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      margin: 1rem;
      line-height: 1.6;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    h1, h2, h3 {
      margin-top: 1rem;
    }

    .song-block {
      margin-bottom: 2rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 1rem;
    }

    .collapsed {
      cursor: pointer;
      font-weight: bold;
      color: #003366;
      padding: 0.5rem;
      background-color: #f0f0f0;
      border-radius: 4px;
    }

    .collapsed:hover {
      background-color: #e0e0e0;
    }

    .expanded {
      margin-top: 0.5rem;
    }

    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }

    table.lyrics {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    table.lyrics th, table.lyrics td {
      border: 1px solid #ccc;
      padding: 0.2rem;
      vertical-align: top;
    }

    table.lyrics th {
      background-color: #f0f0f0;
      text-align: left;
    }

    @media (max-width: 600px) {
      body {
        font-size: 1.3rem;
      }

      h1, h2, h3 {
        font-size: 1.4rem;
      }

      p, .collapsed {
        font-size: 1.2rem;
      }

      .collapsed {
        padding: 0.75rem;
      }
    }
    #menu {
  margin-bottom: 1rem;
  display: flex;
  gap: 1rem;
}

#menu button {
  padding: 0.5rem 1rem;
  font-size: 1rem;
  background-color: #003366;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
    
#menu button:hover {
  background-color: #005599;
}

@media (max-width: 600px) {
  #menu {
    flex-direction: column;
  }

  #menu button {
    font-size: 1.2rem;
  }
}
#playlistSelector {
  padding: 0.5rem 1rem;
  font-size: 1rem;
  background-color: #003366;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#playlistSelector option {
  color: black;
}

@media (max-width: 600px) {
  #playlistSelector {
    font-size: 1.2rem;
  }
}

</style>
</head>
<body>
  <h1>Opa's klassieke canon</h1>
<nav id="menu">
  <select id="playlistSelector" onclick="updatePlaylist()" onchange="updatePlaylist()">
    <option value="canon">üéµ Canon</option>
    <option value="kerstmis">üéÑ Kerstmis</option>
    <option value="wiegelied">üõèÔ∏è Wiegelied</option>
  </select>
  <button onclick="showSection('content')">üéº Componisten</button>
</nav>


  <div id="playlist"></div>
  <div id="content"></div>

<script>
  const playlist = document.getElementById("playlist");
  const content = document.getElementById("content");
  let composers = [];
  let songs = [];

  // Cross-browser veilige datum-parser.
  // Safari kan problemen hebben met het rechtstreeks parsen van "YYYY-MM-DD".
  // We maken daarom zelf een Date-object op basis van jaar/maand/dag wanneer mogelijk.
function parseDateSafe(text) {
  if (!text) return new Date(2000, 0, 1);

  const s = text.trim();

  // YYYY-MM-DD
  const iso = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if (iso) return new Date(parseInt(iso[1],10), parseInt(iso[2],10)-1, parseInt(iso[3],10));

  // YYYY/MM/DD
  const sl = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
  if (sl) return new Date(parseInt(sl[1],10), parseInt(sl[2],10)-1, parseInt(sl[3],10));

  // Normaliseer spaties/newlines (bijv. "2024\n 11\n 01") naar YYYY/MM/DD als mogelijk
  const nums = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
  if (nums) return new Date(parseInt(nums[1],10), parseInt(nums[2],10)-1, parseInt(nums[3],10));

  // Fallback: vervang '-' door '/' en probeer Date.parse
  const normalized = s.replace(/-/g, '/').replace(/\s+/g, ' ');
  const ts = Date.parse(normalized);
  return isNaN(ts) ? new Date(2000, 0, 1) : new Date(ts);
}

  function showSection(section) {
  if (section === "playlist") {
    playlist.style.display = "block";
    content.style.display = "none";
  } else if (section === "content") {
    playlist.style.display = "none";
    content.style.display = "block";
	renderComposerTimeline();
  }
}
  function selectPlaylist(name) {
  const selector = document.getElementById("playlistSelector");
  selector.value = name;
  updatePlaylist();
}

  function updatePlaylist() {
  const selected = document.getElementById("playlistSelector").value;

    fetch("canon.xml")
    .then(res => res.text())
    .then(str => {
      const xml = new DOMParser().parseFromString(str, "application/xml");

      // Vul composers en songs opnieuw
      composers = [...xml.getElementsByTagName("composer")];
      songs = [...xml.getElementsByTagName("song")];

      // Render de juiste playlist
      renderPlaylist(selected);

      // Toon de playlist-sectie
      showSection("playlist");
    })
    .catch(err => {
      console.error("Fout bij laden van canon.xml:", err);
    });
}

  function renderPlaylist(selectedPlaylist) {
  playlist.innerHTML = "";

  const filteredSongs = songs
  .sort((a, b) => {
    function getAppendDate(song) {
      const ad = song.querySelector('appenddate');
      if (!ad) return new Date(2000,0,1);

      // Als appenddate heeft child elementen <year>, <month>, <day>, gebruik die
      const yEl = ad.querySelector('year');
      const mEl = ad.querySelector('month');
      const dEl = ad.querySelector('day');
      if (yEl && mEl && dEl) {
        const y = parseInt(yEl.textContent.trim(), 10) || 2000;
        const m = Math.max(1, parseInt(mEl.textContent.trim(), 10) || 1) - 1;
        const d = parseInt(dEl.textContent.trim(), 10) || 1;
        return new Date(y, m, d);
      }

      // Anders: gebruik textContent en parseDateSafe
      const txt = (ad.textContent || '').trim();
      return parseDateSafe(txt);
    }

    const dateA = getAppendDate(a);
    const dateB = getAppendDate(b);

    // Debugging: (optioneel) console.log de parsed dates
    // console.log('parsed dates', a.querySelector('ID')?.textContent, dateA, b.querySelector('ID')?.textContent, dateB);

    return dateB - dateA;
  })
  .filter(song => {
    const pl = song.querySelector("playlist")?.textContent.toLowerCase() || "canon";
    return pl === selectedPlaylist.toLowerCase();
  });

  filteredSongs.forEach((song, index) => {
    const title = song.querySelector("title")?.textContent || "";
    const artist = song.querySelector("artist")?.textContent || "";
    const spotify = song.querySelector("spotify")?.textContent || "";
    const narrative = song.querySelector("narrative")?.textContent || "";

    // ‚úÖ Lyrics ophalen uit songtext of direct
    const original = song.querySelector("original")?.textContent ||
                     song.querySelector("songtext > original")?.textContent || "";
    const translation = song.querySelector("translation")?.textContent ||
                        song.querySelector("songtext > translation")?.textContent || "";

    const composerId = song.querySelector("reference")?.textContent || "";
    const composer = composers.find(c => c.querySelector("ID")?.textContent === composerId);
    const composerName = composer ? `${composer.querySelector("name")?.textContent} ${composer.querySelector("familyname")?.textContent}` : "";
    const birthPlace = composer?.querySelector("placeofbirth")?.textContent || "";
    const birthYear = composer?.querySelector("yearofbirth")?.textContent || "";
    const deathPlace = composer?.querySelector("placeofdeath")?.textContent || "";
    const deathYear = composer?.querySelector("yearofdeath")?.textContent || "";
    const lifeSpan = deathYear
      ? `${birthPlace}: ${birthYear} ‚Äì ${deathPlace}: ${deathYear}`
      : `${birthPlace}: ${birthYear} ‚Äì heden`;

    // Bepaal Appenddate en formatteer voor weergave onder de artiest
    const adNode = song.querySelector('appenddate');
    let appendDateText = "";
    if (adNode) {
      const yEl = adNode.querySelector('year');
      const mEl = adNode.querySelector('month');
      const dEl = adNode.querySelector('day');
      let adDate;
      if (yEl && mEl && dEl) {
        const y = parseInt(yEl.textContent.trim(), 10) || 2000;
        const m = Math.max(1, parseInt(mEl.textContent.trim(), 10) || 1) - 1;
        const d = parseInt(dEl.textContent.trim(), 10) || 1;
        adDate = new Date(y, m, d);
      } else {
        adDate = parseDateSafe(adNode.textContent || "");
      }
      // Format als bijv. "1 november 2024"
      try {
        appendDateText = `Toegevoegd: ${adDate.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })}`;
      } catch (e) {
        // Fallback simpele ISO-datum
        appendDateText = `Toegevoegd: ${adDate.getFullYear()}-${String(adDate.getMonth()+1).padStart(2,'0')}-${String(adDate.getDate()).padStart(2,'0')}`;
      }
    }

    const block = document.createElement("div");
    block.className = "song-block";

    const collapsed = document.createElement("div");
    collapsed.className = "collapsed";
    collapsed.textContent = `${composerName}: ${title}`;

    const expanded = document.createElement("div");
    expanded.className = "expanded";
    expanded.style.display = index < 2 ? "block" : "none";
    collapsed.style.display = index < 2 ? "none" : "block";

    expanded.innerHTML = `
      <p style="font-size: 0.9rem; margin-bottom: 0.2rem;">
        <strong>${composerName}</strong> (${lifeSpan})
      </p>
      <h3>${title}</h3>
      ${artist ? `<p><strong>Artiest:</strong> ${artist}</p>` : ""}
      ${appendDateText ? `<p style="margin-top:0.2rem;"><em>${appendDateText}</em></p>` : ""}
      <p>${narrative}</p>
      ${original && translation ? `
        <table class="lyrics">
          <tr><th>Origineel</th><th>Vertaling</th></tr>
          ${original.split("<br>").map((line, i) => `
            <tr>
              <td>${line}</td>
              <td>${translation.split("<br>")[i] || ""}</td>
            </tr>
          `).join("")}
        </table>
      ` : ""}
      ${spotify ? `<p><a href="${spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
    `;

    const toggleBtn = document.createElement("button");
    toggleBtn.textContent = "Sluit";
    toggleBtn.onclick = () => {
      expanded.style.display = "none";
      collapsed.style.display = "block";
    };
    expanded.appendChild(toggleBtn);

    collapsed.onclick = () => {
      expanded.style.display = "block";
      collapsed.style.display = "none";
    };

    block.appendChild(collapsed);
    block.appendChild(expanded);
    playlist.appendChild(block);
  });
}
  function renderComposerTimeline() {
	content.innerHTML = ''; // wis vorige inhoud

	const svgNS = "http://www.w3.org/2000/svg";
	const svg = document.createElementNS(svgNS, "svg");
	const containerWidth = content.clientWidth || 800; // fallback
	const scaleWidth = 0.75 * containerWidth;
	const nameWidth = 0.25 * containerWidth;
	svg.setAttribute("width", containerWidth);
	const svgHeight = composers.length * 30 + 50;
	svg.setAttribute("height", svgHeight);
	
	svg.style.border = "1px solid red";

	const startYear = 1000;
	const scaleExp = 4;
	const endYear = new Date().getFullYear();
	const totalYears = Math.pow(endYear/startYear, scaleExp) - 1;
  // const svgWidth = 1000; // px
	const yearToX = year => ((Math.pow(year/startYear,scaleExp) - 1) / totalYears) * scaleWidth + nameWidth;
	 
	const centuryMarks = [];

	for (let y = startYear; y <= endYear; y += 100) {
		centuryMarks.push(y);
	} 
	
	centuryMarks.forEach(year => {
		const x = yearToX(year);

		// Verticale lijn
		const line = document.createElementNS(svgNS, "line");
		line.setAttribute("x1", x);
		line.setAttribute("y1", 0);
		line.setAttribute("x2", x);
		line.setAttribute("y2", svgHeight); // of max y van je balken
		line.setAttribute("stroke", "#ccc");
		line.setAttribute("stroke-width", "1");
		svg.appendChild(line);

		// Label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", x - 5);
		label.setAttribute("y", 30); // bovenaan
		label.setAttribute("transform", `rotate(-45 ${x - 5},10)`); // 45¬∞ linksom
		label.setAttribute("font-size", "10");
		label.setAttribute("fill", "#333");
		label.textContent = year;
		svg.appendChild(label);
	});
	
	 
	composers.sort((a, b) => {
		const ay = parseInt(a.querySelector("yearofbirth")?.textContent || "0");
		const by = parseInt(b.querySelector("yearofbirth")?.textContent || "0");
		return ay - by;
	});
  
	composers.forEach((composer, index) => {
		const name = composer.querySelector("familyname")?.textContent || "Onbekend";
		const birth = parseInt(composer.querySelector("yearofbirth")?.textContent || "1900");
		const death = parseInt(composer.querySelector("yearofdeath")?.textContent || (birth + 10));
		const y = index * 30 + 40;
	
	//Debugging
		console.log({
			name,
			birth,
			death,
			x: yearToX(birth),
			width: yearToX(death) - yearToX(birth)
		});
		
		const style = composer.querySelector("style")?.textContent.toLowerCase();
		const colorMap = {
			barok: "#8B0000",
			klassiek: "#1E90FF",
			romantiek: "#228B22",
			modern: "#FF8C00"
		};
		const fillColor = colorMap[style] || "#555";

		// Levenslijn
		const line = document.createElementNS(svgNS, "rect");
		line.setAttribute("x", yearToX(birth));
		line.setAttribute("y", y);
		line.setAttribute("width", yearToX(death) - yearToX(birth));
		line.setAttribute("height", 10);
		line.setAttribute("fill", fillColor);
		svg.appendChild(line);

		// Naam label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", 5);
		label.setAttribute("y", y + 8);
		label.setAttribute("fill", "#000");
		label.setAttribute("font-size", "12");
		label.textContent = name;
		svg.appendChild(label);
	});
  
	content.appendChild(svg);
  }

  function renderComposers() {
    content.innerHTML = "";

    composers.forEach(comp => {
      const id = comp.querySelector("ID")?.textContent || "";
      const name = comp.querySelector("name")?.textContent || "";
      const family = comp.querySelector("familyname")?.textContent || "";
      const style = comp.querySelector("style")?.textContent || "";
      const birth = comp.querySelector("yearofbirth")?.textContent || "";
      const death = comp.querySelector("yearofdeath")?.textContent || "";
      const narrative = comp.querySelector("narrative")?.textContent || "";

      const composerDiv = document.createElement("div");
      composerDiv.className = "composer";
      composerDiv.innerHTML = `
        <h2>${name} ${family}</h2>
        <p><strong>Stijl:</strong> ${style}</p>
        <p><strong>Levensjaren:</strong> ${birth} ‚Äì ${death || "heden"}</p>
        <p>${narrative}</p>
      `;

      const relatedSongs = songs.filter(song => song.querySelector("reference")?.textContent === id);
      relatedSongs.forEach(song => {
        const title = song.querySelector("title")?.textContent || "";
        const artist = song.querySelector("artist")?.textContent || "";
        const spotify = song.querySelector("spotify")?.textContent || "";
        const narrative = song.querySelector("narrative")?.textContent || "";
        const original = song.querySelector("original")?.textContent || "";
        const translation = song.querySelector("translation")?.textContent || "";

        const songDiv = document.createElement("div");
        songDiv.className = "song";
        songDiv.innerHTML = `
          <h3>${title}</h3>
          ${artist ? `<p><strong>Artiest:</strong> ${artist}</p>` : ""}
          <p>${narrative}</p>
          ${original && translation ? `
            <table class="lyrics">
              <tr><th>Origineel</th><th>Vertaling</th></tr>
              ${original.split("<br>").map((line, i) => `
                <tr>
                  <td>${line}</td>
                  <td>${translation.split("<br>")[i] || ""}</td>
                </tr>
              `).join("")}
            </table>
          ` : ""}
          ${spotify ? `<p><a href="${spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
        `;
        composerDiv.appendChild(songDiv);
      });

      content.appendChild(composerDiv);
    });
  }

  fetch('canon.xml')
    .then(res => res.text())
    .then(str => {
      const xml = new DOMParser().parseFromString(str, "application/xml");
      composers = [...xml.getElementsByTagName("composer")];
      songs = [...xml.getElementsByTagName("song")];

      renderComposers();
      renderPlaylist("canon");
      showSection("playlist");
    });
</script>

</body>
</html>
