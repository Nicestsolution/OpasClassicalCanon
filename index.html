<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<title>Opa's klassieke canon</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="canonstyle.css">
</head>
<body>
<h1>Opa's klassieke canon</h1>
<nav id="menu">
  <select id="playlistSelector">
    <option value="canon">üéµ Speellijst Canon</option>
    <option value="kerstmis">üéÑ Speellijst Kerstmis</option>
    <option value="wiegelied">üõèÔ∏è Speellijst Wiegelied</option>
  </select>
  <select id="viewSelector">
    <option value="composers">üéº Componisten Lijst</option>
    <option value="timeline">üìÖ Componisten Tijdlijn</option>
  </select>
</nav>
<div id="playlist"></div>
<div id="content"></div>
<script>
const playlist = document.getElementById("playlist");
const content = document.getElementById("content");
let composers = [];
let songs = [];// Cross-browser veilige datum-parser.
// Safari kan problemen hebben met het rechtstreeks parsen van "YYYY-MM-DD".
// We maken daarom zelf een Date-object op basis van jaar/maand/dag wanneer mogelijk.

// Tooltip-element aanmaken
const tooltip = document.createElement("div");
tooltip.className = "svg-tooltip";
document.body.appendChild(tooltip);

// Tooltip timeout
let tooltipTimeout;

// Tooltip verbergfunctie
function hideTooltip() {
  clearTimeout(tooltipTimeout);
  tooltip.style.display = "none";
}

// Verberg tooltip bij scroll, resize, touchmove
window.addEventListener("scroll", hideTooltip);
window.addEventListener("resize", hideTooltip);
window.addEventListener("touchmove", hideTooltip);
window.addEventListener("blur", hideTooltip);


// Sectiewissel
function showSection(section) {
    hideTooltip();
  if (section === "playlist") {
    playlist.style.display = "block";
    content.style.display = "none";
  } else if (section === "content") {
    playlist.style.display = "none";
    content.style.display = "block";
  }
}

function updatePlaylist() {
  const selectedPlaylist = document.getElementById('playlistSelector').value;
  renderPlaylist(selectedPlaylist);
  showSection('playlist');
}

function formatLifeSpan(composer) {
  const birth = composer.birth || "";
  const placeOfBirth = composer.placeofbirth || "";
  const death = composer.death || "";
  const placeOfDeath = composer.placeofdeath || "";
  if (birth || death || placeOfBirth || placeOfDeath) {
    if (!death) {
      return `${placeOfBirth}: ${birth} ‚Äì heden`;
    }
    return `${placeOfBirth}: ${birth} ‚Äì ${placeOfDeath}: ${death}`;
  }
  return "";
}

function createSongDetailBlock(song) {
  const block = document.createElement("div");
  block.className = "song-detail-block";

  const originalLines = song.original ? song.original.split("<br>") : [];
  const translationLines = song.translation ? song.translation.split("<br>") : [];

  const dateString = song.appenddate instanceof Date
    ? song.appenddate.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })
    : "";

  block.innerHTML = `
    <h3>${song.title}</h3>
    ${song.artist ? `<p><strong>Artiest:</strong> ${song.artist}</p>` : ""}
    ${song.playlist ? `<p><strong>Playlist:</strong> ${song.playlist}</p>` : ""}
    ${dateString ? `<p style="margin-top:0.2rem;"><em>Toegevoegd: ${dateString}</em></p>` : ""}
    ${song.narrative ? `<p>${song.narrative}</p>` : ""}
    ${originalLines.length && translationLines.length ? `
      <table class="lyrics">
        <tr><th>Origineel</th><th>Vertaling</th></tr>
        ${originalLines.map((line, i) => `
          <tr>
            <td>${line}</td>
            <td>${translationLines[i] || ""}</td>
          </tr>
        `).join("")}
      </table>
    ` : ""}
    ${song.spotify ? `<p><a href="${song.spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
  `;

  return block;
}

function renderPlaylist(selectedPlaylist) {
	playlist.innerHTML = '';
	content.innerHTML = '';
	const normalizedPlaylist = selectedPlaylist.trim().toLowerCase();
  
	const playlistLinks = {
	  canon: "https://open.spotify.com/playlist/4DqqTg8GBv4Ea8CzmoKraI?si=8b23b688f68341dc",
	  kerstmis: "https://open.spotify.com/playlist/6gDAHEQObs7pH0XR3h5J13?si=5b2ba7357143431c",
	  wiegelied: "https://open.spotify.com/playlist/2duZlB2x7ybq1OH9PwcXZX?si=d4d67d90f7dd4fe7"
	};
	
	const playlistNames = {
	  canon: "Opa's Klassieke Canon ",
	  kerstmis: "Opa's Kerstmuziek ",
	  wiegelied: "Opa's Wiegeliedjes "
	};

	const spotifyURL = playlistLinks[normalizedPlaylist];
	const playlistName = playlistNames[normalizedPlaylist];
	if (spotifyURL) {
	  const spotifyLink = document.createElement("div");
	  spotifyLink.innerHTML = `
		<a href="${spotifyURL}" target="_blank" style="text-decoration: none; font-weight: bold; display: inline-block; margin-bottom: 10px;">
		${playlistName} üéß Luister deze playlist op Spotify
		</a>
	  `;
	  playlist.appendChild(spotifyLink);
	}

	const filteredSongs = songs.filter(song =>     song.playlist?.trim().toLowerCase() === normalizedPlaylist);  
	filteredSongs.sort((a, b) => b.appenddate.getTime() - a.appenddate.getTime());

	filteredSongs.forEach((song, index) => {
    const composer = composers.find(c => c.id === song.composerID);
    const composerName = composer ? `${composer.name} ${composer.familyname}` : "Anoniem";
    const birth = composer ? composer.birth : "";
    const death = composer ? composer.death : "";
    const lifeSpan = composer ? formatLifeSpan(composer) : "";

    const block = document.createElement("div");
    block.className = "song-block";

    const collapsed = document.createElement("div");
    collapsed.className = "collapsed";
    collapsed.innerHTML = `<strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong>: ${song.title}`;

    const expanded = document.createElement("div");
    expanded.className = "expanded";
    expanded.style.display = index < 2 ? "block" : "none";
    collapsed.style.display = index < 2 ? "none" : "block";

    expanded.innerHTML = `
      <p style="font-size: 1rem; margin-bottom: 0.2rem;">
        <strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong> (${lifeSpan})
      </p>
      <h3>${song.title}</h3>
      ${song.artist ? `<p style="font-size: 0.9rem"><strong>Artiest:</strong> ${song.artist}</p>` : ""}
      ${song.appenddate ? `<p style="font-size: 0.9rem; margin-top:0.1rem;"><em>Toegevoegd: ${song.appenddate.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })}</em></p>` : ""}
      <p>${song.narrative}</p>
      ${song.original && song.translation ? `
        <table class="lyrics">
          <tr><th>Origineel</th><th>Vertaling</th></tr>
          ${song.original.split("<br>").map((line, i) => `
            <tr>
              <td>${line}</td>
              <td>${song.translation.split("<br>")[i] || ""}</td>
            </tr>
          `).join("")}
        </table>
      ` : ""}
      ${song.spotify ? `<p><a href="${song.spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
    `;

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Sluit";
    closeBtn.onclick = () => {
      expanded.style.display = "none";
      collapsed.style.display = "block";
    };
    expanded.appendChild(closeBtn);

    expanded.querySelector("a").addEventListener("click", e => {
      e.preventDefault();
      showComposerDetails(composer.id, "playlist");
    });

    collapsed.onclick = () => {
      expanded.style.display = "block";
      collapsed.style.display = "none";
    };

    block.appendChild(collapsed);
    block.appendChild(expanded);
    playlist.appendChild(block);
  });
} 

//-------------Componistenlijst-start------------------
function renderComposers() {
	playlist.innerHTML = '';
	content.innerHTML = '';
	// alfabetisch
	composers.sort((a, b) => a.familyname.localeCompare(b.familyname));

	composers.forEach(composer => {
		const block = document.createElement("div");
		block.className = "composer-block";

		const lifeSpan = composer ? formatLifeSpan(composer) : "";
		const nameLine = `<strong>${composer.familyname}</strong>, ${composer.name}`;
		const styleLine = `<em>${composer.style}</em> (${lifeSpan})`;
		const birth = composer.birth || "?";
		const death = composer.death || "heden";
		//const narrative = composer.description || "";

		// Collapsed view
		const collapsed = document.createElement("div");
		collapsed.className = "composer-collapsed";
		collapsed.innerHTML = `
			<h2 class="composer-name">
				${composer.familyname}, ${composer.name}
				<span class="composer-lifespan">(${lifeSpan})</span>
			</h2>
		`;
	
		collapsed.style.cursor = "pointer";
		collapsed.querySelector('.composer-name').addEventListener('click', () => {
			collapsed.style.display = "none";
			expanded.style.display = "block";
		});

		// Expanded view
		const expanded = document.createElement("div");
		expanded.className = "composer-expanded";
		expanded.style.display = "none";
	
		// Expanded view Titel
		const title = document.createElement("h2");
		title.className = "composer-name";
		title.style.cursor = "pointer";
		title.style.color = "#003366";
		title.textContent = `${composer.familyname}, ${composer.name}`;
		expanded.appendChild(title);

		// Expanded view Stijl + levensspanne
		const stylePara = document.createElement("p");
		stylePara.innerHTML = `<em>${composer.style}</em> (${lifeSpan})`;
		expanded.appendChild(stylePara);

		// Expanded view Beschrijving
		const descPara = document.createElement("p");
		descPara.innerHTML = composer.description;
		expanded.appendChild(descPara);
	
		// Expanded view Songs
		const composerSongs = songs.filter(song => song.composerID === composer.id);
		composerSongs.sort((a, b) => b.appenddate.getTime() - a.appenddate.getTime());
		composerSongs.forEach(song => {
			const songDiv = document.createElement("div");
			songDiv.className = "song-block";
			const collapsedSong = document.createElement("div");
			collapsedSong.className = "collapsed";
			collapsedSong.innerHTML = `<a href="#" text-decoration:none"></a>${song.title}`;

			const expandedSong = document.createElement("div");
			expandedSong.className = "expanded";
			expandedSong.style.display = "none";
			collapsedSong.style.display = "block";
			expandedSong.appendChild(createSongDetailBlock(song));
			
			// Toggle
			collapsedSong.onclick = () => {
				expandedSong.style.display = "block";
				collapsedSong.style.display = "none";
			};		
		
			// Sluit song knop
			const closeBtnSong = document.createElement("button");
			closeBtnSong.textContent = "Sluit muzieknummer";
			closeBtnSong.onclick = () => {
				expandedSong.style.display = "none";
				collapsedSong.style.display = "block";
			};
			expandedSong.appendChild(closeBtnSong);
				
			songDiv.appendChild(collapsedSong);
			songDiv.appendChild(expandedSong);
			expanded.appendChild(songDiv);
		});	

		// Sluit-knop
		const closeBtn = document.createElement("button");
		closeBtn.textContent = "Sluit Componist";
		closeBtn.onclick = () => {
			expanded.style.display = "none";
			collapsed.style.display = "block";
		};
		expanded.appendChild(closeBtn);

		// Toggle
		collapsed.onclick = () => {
			collapsed.style.display = "none";
			expanded.style.display = "block";
		};

		block.appendChild(collapsed);
		block.appendChild(expanded);
		content.appendChild(block);
	});
  
}
//-------------Componistenlijst-eind------------------


//-------------Componistentijdlijn-begin-----------------
function renderComposerTimeline() {
	playlist.innerHTML = '';
	content.innerHTML = '';
	const svgNS = "http://www.w3.org/2000/svg";
		
	// Legenda
	const legend = document.createElement("div");
		legend.className = "timeline-legend";
		legend.style.display = "flex";
		legend.style.flexWrap = "wrap";
		legend.style.gap = "1rem";
		legend.style.marginBottom = "1rem";
		legend.style.alignItems = "center";
	
	const colorMap = {
		gregoriaans: "#AA9922",
		middeleeuws: "#644BB4",
		renaissance: "#60C600",
		barok: "#BB0050",
		klassiek: "#1E90FF",
		romantiek: "#228B22",
		impressionisme: "#EE88AA",
		modern: "#EE8C00",
		postmodern: "#AA00AA"
	};
	
	Object.entries(colorMap).forEach(([style, color]) => {
	  const item = document.createElement("div");
	  item.style.display = "flex";
	  item.style.alignItems = "center";
	  item.style.gap = "0.5rem";

	  const swatch = document.createElement("div");
	  swatch.style.width = "16px";
	  swatch.style.height = "16px";
	  swatch.style.backgroundColor = color;
	  swatch.style.border = "1px solid #333";

	  const label = document.createElement("span");
	  label.textContent = style.charAt(0).toUpperCase() + style.slice(1);

	  item.appendChild(swatch);
	  item.appendChild(label);
	  legend.appendChild(item);
	});
	
	const svg = document.createElementNS(svgNS, "svg"); 
	const containerWidth = content.clientWidth || 800; // fallback
	const scaleWidth = 0.8 * containerWidth;
	const nameWidth = 0.2 * containerWidth;
	svg.setAttribute("width", containerWidth);
	const svgHeight = composers.length * 25 + 40;
	svg.setAttribute("height", svgHeight);
	
	svg.style.border = "1px solid #ccc";

	const startYear = 1000;
	const scaleExp = 3;
	const endYear = new Date().getFullYear();
	const totalYears = Math.pow(endYear/startYear, scaleExp) - 1;
  // const svgWidth = 1000; // px
	const yearToX = year => ((Math.pow(year/startYear,scaleExp) - 1) / totalYears) * scaleWidth + nameWidth;
	 
	const centuryMarks = [];

	for (let y = startYear; y <= endYear; y += 100) {
		centuryMarks.push(y);
	} 
	
	centuryMarks.forEach(year => {
		const x = yearToX(year);

		// Verticale lijn
		const line = document.createElementNS(svgNS, "line");
		line.setAttribute("x1", x);
		line.setAttribute("y1", 0);
		line.setAttribute("x2", x);
		line.setAttribute("y2", svgHeight); // of max y van je balken
		line.setAttribute("stroke", "#ccc");
		line.setAttribute("stroke-width", "1");
		svg.appendChild(line);

		// Label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", x + 10);
		label.setAttribute("y", 30); // bovenaan
		label.setAttribute("transform", `rotate(-60 ${x + 10},30)`); // 60¬∞ linksom
		label.setAttribute("font-size", "12");
		label.setAttribute("fill", "#333");
		label.textContent = year;
		svg.appendChild(label);
	}); 
  
	// chronologisch
	composers.sort((a, b) => a.birth - b.birth);

	// Levenslijn
	composers.forEach((composer, index) => {
		const initials = composer.name
		  .split(" ")
		  .map(part => part[0])
		  .join(".") + ".";
		const style = composer.style.toLowerCase();
		const fillColor = colorMap[style] || "#555";
		const death = composer.death || endYear;
		
		const y = index * 25 + 40;
		const line = document.createElementNS(svgNS, "rect");
		line.setAttribute("x", yearToX(composer.birth));
		line.setAttribute("y", y);
		line.setAttribute("width", yearToX(death) - yearToX(composer.birth));
		line.setAttribute("height", 14);
		line.setAttribute("fill", fillColor);
		line.style.cursor = "pointer";
		line.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		line.addEventListener("mouseenter", e => {
		    tooltip.textContent = `${composer.name} ${composer.familyname}`;
		    tooltip.style.display = "block";
		    clearTimeout(tooltipTimeout); // reset vorige timer
            tooltipTimeout = setTimeout(() => {
                tooltip.style.display = "none";
            }, 5000); // verberg na 5 seconden
		});
		line.addEventListener("touchstart", e => {
            tooltip.textContent = `${composer.name} ${composer.familyname}`;
            tooltip.style.display = "block";
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                tooltip.style.display = "none";
            }, 5000);
        });

		line.addEventListener("mousemove", e => {
		  tooltip.style.left = `${e.pageX + 10}px`;
		  tooltip.style.top = `${e.pageY + 10}px`;
		});

		line.addEventListener("mouseleave", () => {
		  tooltip.style.display = "none";
		});
		
        line.addEventListener("touchend", () => {
          tooltip.style.display = "none";
        });

		svg.appendChild(line);

		// Naam label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", 5);
		label.setAttribute("y", y + 12);
		label.setAttribute("fill", "#000");
		label.setAttribute("font-size", "15");
		label.textContent = `${initials} ${composer.familyname}`;
		label.style.cursor = "pointer";
		label.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		svg.appendChild(label); 
	});
	content.appendChild(legend);	
	content.appendChild(svg);
}
//-------------Componistentijdlijn-eind-----------------

function updateView() {
  const view = document.getElementById('viewSelector').value;
  if (view === 'timeline') {
    showSection('content');
    renderComposerTimeline();
  } else {
    showSection('content');
    renderComposers();
  }
}

// Toon details van een enkele componist
function showComposerDetails(id, fromView) {
  showSection('content');
  content.innerHTML = '';
  const composer = composers.find(c => c.id === id);
  if (!composer) {
    content.textContent = 'Componist niet gevonden.';
    return;
  }
  const detailDiv = document.createElement('div');
  detailDiv.className = 'composer-detail';
  const lifeSpan = formatLifeSpan(composer);
  detailDiv.innerHTML = `
    <h2>${composer.name} ${composer.familyname}</h2>
    <p><em>${composer.style}</em> (${lifeSpan})</p>
    <p>${composer.description}</p>
  `;

  const composerSongs = songs.filter(song => song.composerID === composer.id);
  composerSongs.sort((a, b) => b.appenddate.getTime() - a.appenddate.getTime());
  composerSongs.forEach(song => {
    const songDiv = document.createElement('div');
    songDiv.className = 'song';
    /*
	songDiv.innerHTML = `
      <h3>${song.title}</h3>
      <p><em>${song.artist}</em></p>
    `;
	*/
	const songBlock = document.createElement("div");
	songBlock.className = "song-block";

	const collapsed = document.createElement("div");
	collapsed.className = "collapsed";
	collapsed.innerHTML = `<strong>${song.title}</strong>`;
	collapsed.style.cursor = "pointer";

	const expanded = document.createElement("div");
	expanded.className = "expanded";
	expanded.style.display = "none";
	collapsed.style.display = "block";

	// Vul de songdetails in
	expanded.appendChild(createSongDetailBlock(song));

	// Sluitknop
	const closeBtn = document.createElement("button");
	closeBtn.textContent = "Sluit muzieknummer";
	closeBtn.onclick = () => {
	  expanded.style.display = "none";
	  collapsed.style.display = "block";
	};
	expanded.appendChild(closeBtn);

	// Toggle
	collapsed.onclick = () => {
	  expanded.style.display = "block";
	  collapsed.style.display = "none";
	};

	songBlock.appendChild(collapsed);
	songBlock.appendChild(expanded);
	detailDiv.appendChild(songBlock);

  });

  const closeBtn = document.createElement('button');
	closeBtn.className = 'back';
	closeBtn.textContent = 'Terug';
  closeBtn.addEventListener('click', () => {
    if (fromView === 'timeline') {
      updateView();
    } else if (fromView === 'composers') {
      updateView();
    } else {
      updatePlaylist();
      showSection('playlist');
    }
  });

  content.appendChild(detailDiv);
  content.appendChild(closeBtn);
}

function getTextContent(parent, selector) {
  const el = parent.querySelector(selector);
  return el ? el.textContent.trim() : "";
}

function parseDateFromChildren(node) {
  if (!node) return new Date(2000, 0, 1);
  const year  = parseInt(getTextContent(node, "year"), 10);
  const month = parseInt(getTextContent(node, "month"), 10);
  const day   = parseInt(getTextContent(node, "day"), 10);
  if (isNaN(year) || isNaN(month) || isNaN(day)) return new Date(2000, 0, 1);
  return new Date(year, month - 1, day);
}

function decodeHTMLEntities(text) {
  const textarea = document.createElement('textarea');
  textarea.innerHTML = text;
  return textarea.value;
}

// Initialisatie: laad XML, parseer data, toon standaard playlist
fetch('canon.xml?v=' + Date.now())
  .then(response => response.text())
  .then(xmlText => {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
    composers = Array.from(xmlDoc.querySelectorAll('composer')).map(c => ({
		id: 		decodeHTMLEntities(getTextContent(c, "ID")),
		name: 		decodeHTMLEntities(getTextContent(c, "name")),
		familyname: decodeHTMLEntities(getTextContent(c, "familyname")),
		style: 		decodeHTMLEntities(getTextContent(c, "style")),
		birth: 		decodeHTMLEntities(getTextContent(c, "yearofbirth")), 
		placeofbirth: decodeHTMLEntities(getTextContent(c, "placeofbirth")),
		death: 		decodeHTMLEntities(getTextContent(c, "yearofdeath")), 
		placeofdeath: decodeHTMLEntities(getTextContent(c, "placeofdeath")),
		description: getTextContent(c, "narrative"),
		// color: c.querySelector('color') ? c.querySelector('color').textContent : '#888'
    }));
    songs = Array.from(xmlDoc.querySelectorAll('song')).map(s => ({
      title: 		decodeHTMLEntities(getTextContent(s, "title")),
      artist: 		decodeHTMLEntities(getTextContent(s, "artist")),
      narrative: 	getTextContent(s, "narrative"),
      original: 	getTextContent(s, "original"),
      translation: 	getTextContent(s, "translation"),
      spotify: 		decodeHTMLEntities(getTextContent(s, "spotify")),
      playlist: 	decodeHTMLEntities(getTextContent(s, "playlist")),
      appenddate: 	parseDateFromChildren(s.querySelector("appenddate")),
      composerID: 	decodeHTMLEntities(getTextContent(s, "reference")),	 	  
    }));
    updatePlaylist();
  });

	document.addEventListener("DOMContentLoaded", () => {
	  const playlistSelector = document.getElementById("playlistSelector");
	  const viewSelector = document.getElementById("viewSelector");

	  if (playlistSelector) {
		playlistSelector.addEventListener("change", updatePlaylist);
		playlistSelector.addEventListener("click", updatePlaylist); // extra trigger
	  }

	  if (viewSelector) {
		viewSelector.addEventListener("change", updateView);
		viewSelector.addEventListener("click", updateView); // extra trigger
	  }
	});

 </script> 
 </body> 
 </html>