<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<title>Opa's klassieke canon</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  /* CSS styling voor leesbaarheid, responsiviteit en visuele structuur */
  #menu {
    margin-bottom: 1rem;
    display: flex;
    gap: 1rem;
  }
  #menu button, #playlistSelector, #viewSelector {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    background-color: #003366;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #menu button:hover, #playlistSelector:hover, #viewSelector:hover {
    background-color: #005599;
  }
  #playlistSelector option, #viewSelector option {
    color: black;
  }
  @media (max-width: 600px) {
    #menu {
      flex-direction: column;
    }
    #menu button, #playlistSelector, #viewSelector {
      font-size: 1.2rem;
    }
  }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    margin: 1rem;
    line-height: 1.6;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  h1, h2, h3 {
    margin-top: 1rem;
  }
  .song-block {
    margin-bottom: 2rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 1rem;
  }
  .collapsed {
    cursor: pointer;
    font-weight: bold;
    color: #003366;
    padding: 0.5rem;
    background-color: #f0f0f0;
    border-radius: 4px;
  }
  .collapsed:hover {
    background-color: #e0e0e0;
  }
  .expanded {
    margin-top: 0.5rem;
  }
  button {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
  }
  table.lyrics {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  table.lyrics th, table.lyrics td {
    border: 1px solid #ccc;
    padding: 0.2rem;
    vertical-align: top;
  }
  table.lyrics th {
    background-color: #f0f0f0;
    text-align: left;
  }
  @media (max-width: 600px) {
    body {
      font-size: 1.3rem;
    }
    h1, h2, h3 {
      font-size: 1.4rem;
    }
    p, .collapsed {
      font-size: 1.2rem;
    }
    .collapsed {
      padding: 0.75rem;
    }
  }
  svg {
    border: 1px solid #ccc;
  }
</style>
</head>
<body>
<h1>Opa's klassieke canon</h1>
<nav id="menu">
  <select id="playlistSelector" onclick="updatePlaylist()" onchange="updatePlaylist()">
    <option value="canon">üéµ Canon</option>
    <option value="kerstmis">üéÑ Kerstmis</option>
    <option value="wiegelied">üõèÔ∏è Wiegelied</option>
  </select>
  <select id="viewSelector" onchange="updateView()" onclick="updateView()">
    <option value="composers">üéº Componisten Lijst</option>
    <option value="timeline">üìÖ Tijdlijn</option>
  </select>
</nav>
<div id="playlist"></div>
<div id="content"></div>
<script>
const playlist = document.getElementById("playlist");
const content = document.getElementById("content");
let composers = [];
let songs = [];// Cross-browser veilige datum-parser.
// Safari kan problemen hebben met het rechtstreeks parsen van "YYYY-MM-DD".
// We maken daarom zelf een Date-object op basis van jaar/maand/dag wanneer mogelijk.
function parseDateSafe(text) {
  if (!text) return new Date(2000, 0, 1);
  const s = text.trim();
  // YYYY-MM-DD
  const iso = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if (iso) return new Date(parseInt(iso[1], 10), parseInt(iso[2], 10) - 1, parseInt(iso[3], 10));
  // YYYY/MM/DD
	const sl = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
  if (sl) return new Date(parseInt(sl[1], 10), parseInt(sl[2], 10) - 1, parseInt(sl[3], 10));
  // Normaliseer spaties/newlines (bijv. "2024\n 11\n 01") naar YYYY/MM/DD als mogelijk
  const nums = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
  if (nums) return new Date(parseInt(nums[1], 10), parseInt(nums[2], 10) - 1, parseInt(nums[3], 10));
  return new Date(s);
}

function showSection(section) {
  if (section === "playlist") {
    playlist.style.display = "block";
    content.style.display = "none";
  } else if (section === "content") {
    playlist.style.display = "none";
    content.style.display = "block";
  }
}

function updatePlaylist() {
  const selectedPlaylist = document.getElementById('playlistSelector').value;
  renderPlaylist(selectedPlaylist);
  showSection('playlist');
}

function renderPlaylist(selectedPlaylist) {
  playlist.innerHTML = '';
  content.innerHTML = '';
  const filteredSongs = songs.filter(song => song.playlist === selectedPlaylist);
  filteredSongs.sort((a, b) => b.appenddate - a.appenddate);
  filteredSongs.forEach((song, index) => {
    const composer = composers.find(c => c.id === song.composer);
    const composerName = composer ? `${composer.name}, ${composer.familyname}` : "Anoniem";
    const birth = composer ? composer.birth : "";
    const death = composer ? composer.death : "";
    const lifeSpan = death ? `${birth} ‚Äì ${death}` : `${birth} ‚Äì heden`;

    const block = document.createElement("div");
    block.className = "song-block";

    const collapsed = document.createElement("div");
    collapsed.className = "collapsed";
    collapsed.innerHTML = `<strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong>: ${song.title}`;

    const expanded = document.createElement("div");
    expanded.className = "expanded";
    expanded.style.display = index < 2 ? "block" : "none";
    collapsed.style.display = index < 2 ? "none" : "block";

    expanded.innerHTML = `
      <p style="font-size: 0.9rem; margin-bottom: 0.2rem;">
        <strong><a href="#" style="color:#003366; text-decoration:none; cursor:pointer;">${composerName}</a></strong> (${lifeSpan})
      </p>
      <h3>${song.title}</h3>
      ${song.artist ? `<p><strong>Artiest:</strong> ${song.artist}</p>` : ""}
      ${song.appenddate ? `<p style="margin-top:0.2rem;"><em>Toegevoegd: ${song.appenddate.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' })}</em></p>` : ""}
      <p>${song.narrative}</p>
      ${song.original && song.translation ? `
        <table class="lyrics">
          <tr><th>Origineel</th><th>Vertaling</th></tr>
          ${song.original.split("<br>").map((line, i) => `
            <tr>
              <td>${line}</td>
              <td>${song.translation.split("<br>")[i] || ""}</td>
            </tr>
          `).join("")}
        </table>
      ` : ""}
      ${song.spotify ? `<p><a href="${song.spotify}" target="_blank">üéß Luister op Spotify</a></p>` : ""}
    `;

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Sluit";
    closeBtn.onclick = () => {
      expanded.style.display = "none";
      collapsed.style.display = "block";
    };
    expanded.appendChild(closeBtn);

    // Klikbare componistnaam in collapsed en expanded
    collapsed.querySelector("a").addEventListener("click", e => {
      e.preventDefault();
      showComposerDetails(composer.id, "playlist");
    });
    expanded.querySelector("a").addEventListener("click", e => {
      e.preventDefault();
      showComposerDetails(composer.id, "playlist");
    });

    collapsed.onclick = () => {
      expanded.style.display = "block";
      collapsed.style.display = "none";
    };

    block.appendChild(collapsed);
    block.appendChild(expanded);
    playlist.appendChild(block);
  });
} 

function renderComposers() {
  playlist.innerHTML = '';
  content.innerHTML = '';
  composers.forEach(composer => {
    const composerDiv = document.createElement('div');
    composerDiv.className = 'composer';
    composerDiv.innerHTML = `
      <h2 class="composer-name" style="cursor:pointer; color:#003366;">${composer.familyname}, ${composer.name}</h2>
      <p><em>${composer.style}</em> (${composer.birth} - ${composer.death})</p>
      <p>${composer.description}</p>
    `;
    composerDiv.querySelector('.composer-name').addEventListener('click', () => showComposerDetails(composer.id, 'composers'));
    const composerSongs = songs.filter(song => song.composer === composer.id);
    composerSongs.forEach(song => {
      const songDiv = document.createElement('div');
      songDiv.className = 'song';
      songDiv.innerHTML = `
        <h3>${song.title}</h3>
        <p><em>${song.artist}</em></p>
      `;
      composerDiv.appendChild(songDiv);
    });
    content.appendChild(composerDiv);
  });
}

function renderComposerTimeline() {
	playlist.innerHTML = '';
	content.innerHTML = '';
	const svgNS = "http://www.w3.org/2000/svg";
	const svg = document.createElementNS(svgNS, "svg"); 
	const containerWidth = content.clientWidth || 800; // fallback
	const scaleWidth = 0.8 * containerWidth;
	const nameWidth = 0.2 * containerWidth;
	svg.setAttribute("width", containerWidth);
	const svgHeight = composers.length * 30 + 50;
	svg.setAttribute("height", svgHeight);
	
	svg.style.border = "1px solid #ccc";

	const startYear = 1000;
	const scaleExp = 3;
	const endYear = new Date().getFullYear();
	const totalYears = Math.pow(endYear/startYear, scaleExp) - 1;
  // const svgWidth = 1000; // px
	const yearToX = year => ((Math.pow(year/startYear,scaleExp) - 1) / totalYears) * scaleWidth + nameWidth;
	 
	const centuryMarks = [];

	for (let y = startYear; y <= endYear; y += 100) {
		centuryMarks.push(y);
	} 
	
	centuryMarks.forEach(year => {
		const x = yearToX(year);

		// Verticale lijn
		const line = document.createElementNS(svgNS, "line");
		line.setAttribute("x1", x);
		line.setAttribute("y1", 0);
		line.setAttribute("x2", x);
		line.setAttribute("y2", svgHeight); // of max y van je balken
		line.setAttribute("stroke", "#ccc");
		line.setAttribute("stroke-width", "1");
		svg.appendChild(line);

		// Label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", x - 5);
		label.setAttribute("y", 30); // bovenaan
		label.setAttribute("transform", `rotate(-45 ${x - 5},10)`); // 45¬∞ linksom
		label.setAttribute("font-size", "10");
		label.setAttribute("fill", "#333");
		label.textContent = year;
		svg.appendChild(label);
	}); 
  
	const style = composer.style.toLowerCase();
		const colorMap = {
			middeleeuws: "8C8F7C",
			renaissance: "15A65B",
			barok: "#8B0000",
			klassiek: "#1E90FF",
			romantiek: "#228B22",
			modern: "#FF8C00"
	};
	// Levenslijn
	composers.forEach(composer => {
		const y = index * 30 + 40;
		const fillColor = colorMap[style] || "#555";
		const line = document.createElementNS(svgNS, "rect");
		line.setAttribute("x", yearToX(birth));
		line.setAttribute("y", y);
		line.setAttribute("width", yearToX(death) - yearToX(birth));
		line.setAttribute("height", 10);
		line.setAttribute("fill", fillColor);
		line.style.cursor = "pointer";
		line.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		svg.appendChild(line);

		// Naam label
		const label = document.createElementNS(svgNS, "text");
		label.setAttribute("x", 5);
		label.setAttribute("y", y + 8);
		label.setAttribute("fill", "#000");
		label.setAttribute("font-size", "12");
		label.textContent = familyname;
		label.style.cursor = "pointer";
		label.addEventListener('click', () => showComposerDetails(composer.id, 'timeline'));
		svg.appendChild(label); 
  });

  content.appendChild(svg);
}

function updateView() {
  const view = document.getElementById('viewSelector').value;
  if (view === 'timeline') {
    showSection('content');
    renderComposerTimeline();
  } else {
    showSection('content');
    renderComposers();
  }
}

// Toon details van een enkele componist
function showComposerDetails(id, fromView) {
  showSection('content');
  content.innerHTML = '';
  const composer = composers.find(c => c.id === id);
  if (!composer) {
    content.textContent = 'Componist niet gevonden.';
    return;
  }
  const detailDiv = document.createElement('div');
  detailDiv.className = 'composer-detail';
  detailDiv.innerHTML = `
    <h2>${composer.name}, ${composer.familyname}</h2>
    <p><em>${composer.style}</em> (${composer.birth} - ${composer.death})</p>
    <p>${composer.description}</p>
  `;

  const composerSongs = songs.filter(song => song.composer === composer.id);
  composerSongs.forEach(song => {
    const songDiv = document.createElement('div');
    songDiv.className = 'song';
    songDiv.innerHTML = `
      <h3>${song.title}</h3>
      <p><em>${song.artist}</em></p>
    `;
    detailDiv.appendChild(songDiv);
  });

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Sluit';
  closeBtn.style.marginTop = '1rem';
  closeBtn.style.padding = '0.5rem 1rem';
  closeBtn.style.fontSize = '1rem';
  closeBtn.style.backgroundColor = '#003366';
  closeBtn.style.color = 'white';
  closeBtn.style.border = 'none';
  closeBtn.style.borderRadius = '4px';
  closeBtn.style.cursor = 'pointer';
  closeBtn.addEventListener('click', () => {
    if (fromView === 'timeline') {
      updateView();
    } else if (fromView === 'composers') {
      updateView();
    } else {
      updatePlaylist();
      showSection('playlist');
    }
  });

  content.appendChild(detailDiv);
  content.appendChild(closeBtn);
}

// Initialisatie: laad XML, parseer data, toon standaard playlist
fetch('canon.xml')
  .then(response => response.text())
  .then(xmlText => {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
    composers = Array.from(xmlDoc.querySelectorAll('composer')).map(c => ({
      id: c.getAttribute('id'),
      name: c.querySelector('name').textContent,
      familyname: c.querySelector('familyname').textContent,
      style: c.querySelector('style').textContent,
      birth: parseInt(c.querySelector('yearofbirth').textContent, 10),
	  placeofbirth: parseInt(c.querySelector('placeofbirth').textContent, 10),
      death: parseInt(c.querySelector('yearofdeath').textContent, 10),
	  placeofdeath: parseInt(c.querySelector('placeofdeath').textContent, 10),
      description: c.querySelector('narrative').textContent,
      color: c.querySelector('color') ? c.querySelector('color').textContent : '#888'
    }));
    songs = Array.from(xmlDoc.querySelectorAll('song')).map(s => ({
      title: s.querySelector('title').textContent,
      artist: s.querySelector('artist').textContent,
      narrative: s.querySelector('narrative').textContent,
      original: s.querySelector('original').textContent,
      translation: s.querySelector('translation').textContent,
      spotify: s.querySelector('spotify') ? s.querySelector('spotify').textContent : '',
      playlist: s.querySelector('playlist').textContent,
      appenddate: parseDateSafe(s.querySelector('appenddate').textContent),
      composerID: s.querySelector('reference').textContent
    }));
    updatePlaylist();
  });
 </script> 
 </body> 
 </html>